# Codeswarm Router Protocol

Protocol ID: `codeswarm.router.v1`

This document formally defines the JSON streaming protocol used between:

- Control clients (e.g., OpenClaw)
- The Codeswarm Router (daemon mode)

The router acts as a protocol translator between:

- External control clients (this protocol)
- Internal worker RPC (Codex CLI / future agents)

All messages are newline-delimited JSON (NDJSON).

---

# 1. Envelope

Every message MUST conform to the following envelope:

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "command" | "event",
  "timestamp": "ISO-8601 UTC string",
  ...
}
```

Rules:

- `protocol` MUST equal `codeswarm.router.v1`
- `timestamp` MUST be generated by the sender
- All timestamps MUST be UTC ISO-8601
- Messages MUST be single-line JSON

---

# 2. Commands (stdin → router)

## Command Envelope

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "command",
  "timestamp": "2026-02-25T15:00:00Z",
  "command": "<string>",
  "request_id": "<string>",
  "payload": { ... }
}
```

### Requirements

- `request_id` MUST be unique per client session
- Router MUST echo `request_id` in response events
- Unknown commands MUST produce `command_rejected`

---

## 2.1 inject

Inject a prompt into a running job.

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "command",
  "timestamp": "...",
  "command": "inject",
  "request_id": "req-123",
  "payload": {
    "job_id": "272900",
    "node_id": 0,
    "content": "Hello"
  }
}
```

### Validation Rules

- `job_id` MUST be string
- `node_id` MUST be integer >= 0
- `content` MUST be string

---

# 3. Events (router → stdout)

## Event Envelope

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "2026-02-25T15:00:01Z",
  "event": "<string>",
  "data": { ... }
}
```

---

# 4. Control Plane Events

## 4.1 inject_ack

Emitted immediately after command acceptance.

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "inject_ack",
  "data": {
    "request_id": "req-123",
    "injection_id": "uuid",
    "job_id": "272900",
    "node_id": 0
  }
}
```

---

## 4.2 inject_delivered

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "inject_delivered",
  "data": {
    "request_id": "req-123",
    "injection_id": "uuid",
    "job_id": "272900",
    "node_id": 0
  }
}
```

---

## 4.3 inject_failed

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "inject_failed",
  "data": {
    "request_id": "req-123",
    "injection_id": "uuid",
    "job_id": "272900",
    "node_id": 0,
    "error": "string"
  }
}
```

---

# 5. Runtime Events (Worker-Originated)

All runtime events MUST include:

- `job_id`
- `node_id`
- `injection_id`

## 5.1 turn_started

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "turn_started",
  "data": {
    "job_id": "...",
    "node_id": 0,
    "injection_id": "uuid"
  }
}
```

---

## 5.2 assistant_delta

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "assistant_delta",
  "data": {
    "job_id": "...",
    "node_id": 0,
    "injection_id": "uuid",
    "content": "partial text"
  }
}
```

---

## 5.3 assistant

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "assistant",
  "data": {
    "job_id": "...",
    "node_id": 0,
    "injection_id": "uuid",
    "content": "final text"
  }
}
```

---

## 5.4 turn_complete

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "turn_complete",
  "data": {
    "job_id": "...",
    "node_id": 0,
    "injection_id": "uuid"
  }
}
```

---

## 5.5 usage

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "timestamp": "...",
  "event": "usage",
  "data": {
    "job_id": "...",
    "node_id": 0,
    "injection_id": "uuid",
    "total_tokens": 8175
  }
}
```

---

# 6. Error Handling

Unknown commands MUST produce:

```json
{
  "protocol": "codeswarm.router.v1",
  "type": "event",
  "event": "command_rejected",
  "data": {
    "request_id": "req-123",
    "reason": "unknown command"
  }
}
```

---

# 7. Forward Compatibility

Clients MUST ignore unknown fields.
Router MAY add new events in minor revisions.

Future protocol revisions:

- `codeswarm.router.v2`
- Version negotiation may be added later.

---

# 8. JSON Schema (Draft 2020-12)

This protocol follows JSON Schema Draft 2020-12 for formal validation.

Envelope schema (simplified):

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "required": ["protocol", "type", "timestamp"],
  "properties": {
    "protocol": {"const": "codeswarm.router.v1"},
    "type": {"enum": ["command", "event"]},
    "timestamp": {"type": "string", "format": "date-time"}
  }
}
```

Full per-event schemas should be validated in CI.

---

End of Protocol Specification.
